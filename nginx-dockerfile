# Use busybox como a imagem base
FROM busybox:latest

# Instalar dependências básicas para compilar e instalar o Nginx
RUN echo "Instalando dependências básicas..." && \
    mkdir /temp && \
    wget -P /temp http://ftp.gnu.org/gnu/binutils/binutils-2.30.tar.gz && \
    wget -P /temp http://ftp.gnu.org/gnu/gcc/gcc-8.3.0/gcc-8.3.0.tar.gz && \
    wget -P /temp http://musl.libc.org/releases/musl-1.2.2.tar.gz && \
    tar -xzvf /temp/binutils-2.30.tar.gz -C /temp && \
    tar -xzvf /temp/gcc-8.3.0.tar.gz -C /temp && \
    tar -xzvf /temp/musl-1.2.2.tar.gz -C /temp && \
    echo "Dependências baixadas."

# Compilar e instalar binutils
RUN cd /temp/binutils-2.30 && \
    ./configure && \
    make && \
    make install && \
    echo "binutils instalado."

# Compilar e instalar musl
RUN cd /temp/musl-1.2.2 && \
    ./configure && \
    make && \
    make install && \
    echo "musl instalado."

# Compilar e instalar gcc
RUN cd /temp/gcc-8.3.0 && \
    ./contrib/download_prerequisites && \
    mkdir build && \
    cd build && \
    ../configure --disable-multilib --with-musl && \
    make -j$(nproc) && \
    make install && \
    echo "gcc instalado."

# Limpar arquivos temporários
RUN rm -rf /temp && \
    echo "Arquivos temporários removidos."

# Baixar e instalar o Nginx
RUN echo "Baixando e instalando o Nginx..." && \
    wget http://nginx.org/download/nginx-1.21.6.tar.gz && \
    tar -xzvf nginx-1.21.6.tar.gz && \
    cd nginx-1.21.6 && \
    ./configure --without-http_rewrite_module --without-http_gzip_module && \
    make && \
    make install && \
    cd / && \
    rm -rf nginx-1.21.6* && \
    echo "Nginx instalado com sucesso."

# Criar diretório para logs do Nginx
RUN echo "Criando diretório para logs do Nginx..." && \
    mkdir -p /var/log/nginx && \
    echo "Diretório criado com sucesso."

# Copiar o arquivo de configuração do Nginx
COPY nginx.conf /etc/nginx/nginx.conf

# Expor a porta 80
EXPOSE 80

# Definir o entrypoint para executar o Nginx em primeiro plano
ENTRYPOINT ["nginx", "-g", "daemon off;"]
